server {
    listen 80;
    server_name localhost;

    # Augmente la limite d'upload (ex: 20Mo) pour éviter l'erreur "413 Request Entity Too Large"
    # car NPM peut autoriser de gros fichiers, mais ce Nginx bloquerait par défaut à 1Mo.
    client_max_body_size 20M;

    root /usr/share/nginx/html;
    index index.html;

    # Frontend (SPA)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API Backend
    location /api/ {
        # Le trailing slash (/) à la fin est crucial ici : 
        # Il transforme '/api/users' en '/users' pour le backend.
        proxy_pass http://gatchalife-backend:8000/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # MODIFICATION CRITIQUE :
        # On passe le protocole reçu de NPM ($http_x_forwarded_proto).
        # Si on laisse $scheme, le backend verra "http" au lieu de "https".
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # Fichiers statiques du backend (si non gérés par WhiteNoise)
    location /static/ {
        # Pas de trailing slash ici pour préserver le chemin complet (/static/...)
        proxy_pass http://gatchalife-backend:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # Médias (Images uploadées)
    location /images/ {
        # S'assure que le volume est bien monté dans le docker-compose sur ce chemin
        alias /usr/share/nginx/media/;
    }

    # Interface Admin Django
    location /admin/ {
        proxy_pass http://gatchalife-backend:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # Webhooks N8N
    location /webhooks/ {
        proxy_pass http://gatchalife-backend:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }
}