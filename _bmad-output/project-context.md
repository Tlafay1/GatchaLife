---
project_name: 'GatchaLife'
user_name: 'Tlafay'
date: '2026-01-11T22:15:00'
sections_completed: ['technology_stack', 'language_framework_rules', 'testing_quality_rules', 'critical_rules']
existing_patterns_found: 22
---

# Project Context for AI Agents

_This file contains critical rules and patterns that AI agents must follow when implementing code in this project. Focus on unobvious details that agents might otherwise miss._

---

## Technology Stack & Versions

- **Frontend:**
  - Vue 3.5
  - Vite 7
  - TypeScript 5.9
  - Pinia (State Management)
  - TanStack Query (Data Fetching)
  - Tailwind CSS v4
  - Shadcn-Vue (Components)
  - Capacitor (Native Bridge)
- **Backend:**
  - Python 3.12+
  - Django 5.2
  - Django REST Framework 3.16
  - Celery 5.3 (Background Tasks)
  - Redis (Queue/Cache)
  - PostgreSQL (Database)

## Critical Implementation Rules

### Language & Framework Rules

#### TypeScript / Vue 3.5 (Frontend)
- **API Contract First**: Use only types generated by `api:sync` (`openapi-typescript-codegen`). Do NOT manually define types for API models.
- **Naming**: Components used `PascalCase`. Files use `kebab-case`. Internal logic uses `camelCase`.
- **State**: Use Pinia for global state (current companion) and TanStack Query for server state.
- **CSS**: Use Tailwind CSS v4 utility classes. Avoid custom CSS unless implementing complex "Glass Menagerie" effects.

#### Python 3.12 / Django 5.2 (Backend)
- **Naming**: Strict `snake_case` for all variables, functions, and database fields.
- **Mana System**: Follow the "Hard Schema Reset" rule. Any new companion stats must be added to the `CompanionState` model under the `mana` system.
- **Background Tasks**: All decay and reward calculations MUST be performed via Celery. Never run long-running logic in the request-response cycle.
- **Contract Safety**: Always run `openapi-typescript-codegen` sync after modifying DRF serializers.

#### Error Handling ("Polite Fail")
- **Frontend**: Catch errors and display generic "polite" toasts. Never expose raw traceback to the user.
- **Backend**: Use standard DRF response formats with consistent error keys.

### Testing & Quality Rules

#### Testing Strategy
- **Unit Tests**: Required for any logic in `gatchalife/gamification` (Mana decay, reward math).
- **Integration Tests**: Mock n8n webhooks to test task ingestion flows.
- **Frontend Tests**: Use Vitest for Pinia store logic and component mounting.

#### Asset Management (Pre-Caching)
- **Contextual Fetch**: When a character is equipped, the frontend MUST pre-fetch all 5 mood variants immediately.
- **Native Optimization**: Android code must check the local cache before attempting network fetches to minimize battery drain.

### Critical Don't-Miss Rules ("The Gotschas")

- **The 15m Delay**: Agents must remember that the Home Screen Widget polls every 15m. Real-time updates inside the app must be reflected via local state *immediately* before the next polling cycle syncs the source of truth.
- **Haunting Atomic Rules**: The "Shadow State" penalty (-50% Coins) must be calculated *at the moment of task completion*. If a companion died 1 second ago, the penalty applies.
- **AI Visual Consistency**: All Forge image generation prompts MUST append the "Glass Menagerie" fixed negative prompt to prevent style drift.
- **No Forward Dependencies**: When implementing stories, NEVER assume features from future implementation epics are available.
